# .github/workflows/update-dashboard.yml
# WARNING: 15-minute frequency will consume ~35,000 GitHub Actions minutes per year
# Ensure you have sufficient quota or consider GitHub Enterprise
name: Update Dashboard

on:
  schedule:
    # Runs every 15 minutes as requested
    - cron: '*/15 * * * *'
  workflow_dispatch:

# Prevent concurrent runs - critical for 15-minute frequency
concurrency:
  group: dashboard-update
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Prevent long-running jobs with high frequency
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch latest changes to avoid conflicts
          fetch-depth: 0

      - name: Pull latest changes first
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git pull --rebase origin ${{ github.ref_name }}

      - name: Generate new dashboard content
        run: |
          # Store previous content for comparison
          if [ -f index.html ]; then
            cp index.html index.html.backup
          fi
          
          # Generate new content
          echo "<h1>My Live Dashboard</h1>" > index.html
          echo "<p>Last updated: $(date)</p>" >> index.html
          echo "<p>Build number: ${{ github.run_number }}</p>" >> index.html
          
          # Add your actual dashboard generation logic here
          # ./scripts/generate-dashboard.sh || exit 1

      - name: Check for meaningful changes
        id: changes
        run: |
          # Compare with backup, excluding timestamp lines
          if [ -f index.html.backup ]; then
            # Remove timestamp lines for comparison
            grep -v "Last updated:" index.html > index.html.clean || true
            grep -v "Last updated:" index.html.backup > index.html.backup.clean || true
            
            if ! diff -q index.html.clean index.html.backup.clean > /dev/null 2>&1; then
              echo "meaningful_changes=true" >> $GITHUB_OUTPUT
            else
              echo "meaningful_changes=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "meaningful_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.meaningful_changes == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add index.html
          if ! git diff --staged --quiet; then
            git commit -m "Automated dashboard update - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            
            # Enhanced retry logic for high-frequency updates
            for i in {1..5}; do
              if git push; then
                echo "Successfully pushed changes"
                break
              else
                echo "Push failed, attempt $i/5 - trying to sync"
                if [ $i -eq 5 ]; then
                  echo "Failed to push after 5 attempts"
                  exit 1
                fi
                # Pull changes and retry
                sleep $((i * 2))
                git pull --rebase origin ${{ github.ref_name }} || git reset --hard HEAD~1
              fi
            done
          else
            echo "No changes to commit."
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "Dashboard update failed. Check the workflow logs."
          # You could add Slack/Discord notifications here